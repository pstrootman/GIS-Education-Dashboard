<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Embed</title>
    
    <!-- External CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.0/dist/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
    
    <!-- Embed-specific styles -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            overflow-x: hidden;
        }
        
        .embed-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .embed-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
        }
        
        .embed-title {
            margin: 0;
            font-size: 1.2rem;
            color: #333;
            font-weight: 600;
        }
        
        .embed-controls {
            display: flex;
            gap: 10px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .embed-timeline-container {
            flex: 1;
            position: relative;
            min-height: 0;
        }
        
        #embed-timeline {
            width: 100%;
            height: 100%;
        }
        
        .perspective-btn, .theme-btn {
            padding: 4px 8px;
            font-size: 0.8rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .perspective-btn.active, .theme-btn.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .perspective-btn:hover, .theme-btn:hover {
            background-color: #f8f9fa;
        }
        
        .perspective-btn.active:hover, .theme-btn.active:hover {
            background-color: #0056b3;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.1rem;
            color: #666;
        }
        
        .error {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #dc3545;
            flex-direction: column;
        }
        
        /* Embed description styling */
        .embed-description {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 15px 20px;
        }
        
        .embed-description-content {
            max-width: 100%;
            line-height: 1.6;
            color: #495057;
        }
        
        #embed-timeline-description {
            font-size: 0.9rem;
        }
        
        #embed-timeline-description h1 {
            font-size: 1.3rem;
            margin: 0.5em 0;
        }
        
        #embed-timeline-description h2 {
            font-size: 1.2rem;
            margin: 0.5em 0;
        }
        
        #embed-timeline-description h3 {
            font-size: 1.1rem;
            margin: 0.5em 0;
        }
        
        #embed-timeline-description p {
            margin: 0.5em 0;
        }
        
        #embed-timeline-description ul, #embed-timeline-description ol {
            margin: 0.5em 0;
            padding-left: 1.5em;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .embed-header {
                padding: 8px 12px;
            }
            
            .embed-title {
                font-size: 1rem;
            }
            
            .perspective-btn, .theme-btn {
                font-size: 0.7rem;
                padding: 3px 6px;
            }
            
            .embed-description {
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="embed-container">
        <!-- Header with timeline title and controls -->
        <div class="embed-header">
            <h1 class="embed-title" id="embed-title">Loading Timeline...</h1>
            <div class="embed-controls">
                <div id="perspective-controls" style="display: none;">
                    <small style="margin-right: 8px; color: #666;">Perspectives:</small>
                    <span id="perspective-buttons"></span>
                </div>
                <div id="theme-controls" style="display: none;">
                    <small style="margin-right: 8px; color: #666;">Themes:</small>
                    <span id="theme-buttons"></span>
                </div>
            </div>
        </div>
        
        <!-- Timeline description -->
        <div class="embed-description" id="embed-description-container" style="display: none;">
            <div class="embed-description-content">
                <div id="embed-timeline-description"></div>
            </div>
        </div>
        
        <!-- Timeline container -->
        <div class="embed-timeline-container">
            <div id="embed-timeline"></div>
            <div id="loading-indicator" class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <span style="margin-left: 10px;">Loading timeline data...</span>
            </div>
            <div id="error-indicator" class="error" style="display: none;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <span>Failed to load timeline data</span>
                <small style="margin-top: 5px; color: #666;">Please check your connection and try again</small>
            </div>
        </div>
    </div>

    <!-- External JavaScript Libraries -->
    <script src="https://unpkg.com/vis-timeline@7.7.0/standalone/umd/vis-timeline-graph2d.min.js"></script>
    
    <!-- Firebase Scripts with error handling -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js" 
            onerror="console.error('Failed to load Firebase App')"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js" 
            onerror="console.error('Failed to load Firebase Firestore')"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js" 
            onerror="console.error('Failed to load Firebase Auth')"></script>
    
    <!-- Firebase configuration -->
    <script src="firebase-config.js" 
            onerror="console.error('Failed to load Firebase config')"></script>
    
    <script>
        // Log Firebase script loading
        console.log('🔥 Firebase scripts loading...');
        window.addEventListener('load', function() {
            console.log('🔥 All scripts loaded, Firebase available:', typeof firebase !== 'undefined');
        });
    </script>
    
    <!-- Embed timeline script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let timelineData;
            let timeline;
            let visTimelineItems = new vis.DataSet([]);
            let activePerspective = null;
            let activeThemes = new Set();
            
            // Add a delay to ensure Firebase is properly initialized
            console.log('DOM loaded, waiting for Firebase initialization...');
            
            // Check Firebase availability multiple times with increasing delays
            let initAttempts = 0;
            const maxAttempts = 10;
            
            function checkFirebaseAndInit() {
                initAttempts++;
                console.log(`🔥 Firebase check attempt ${initAttempts}/${maxAttempts}`);
                
                // Detailed Firebase availability check
                const firebaseAvailable = typeof firebase !== 'undefined';
                console.log('   Firebase SDK available:', firebaseAvailable);
                
                if (firebaseAvailable) {
                    console.log('   Firebase version:', firebase.SDK_VERSION || 'Unknown');
                    console.log('   Firebase apps initialized:', firebase.apps ? firebase.apps.length : 0);
                    console.log('   Firebase services:', Object.keys(firebase));
                    
                    if (firebase.apps && firebase.apps.length > 0) {
                        console.log('   First app config:', firebase.apps[0].options);
                    }
                    
                    // Check for Firebase initialization functions
                    console.log('   isFirebaseReady function:', typeof window.isFirebaseReady);
                    if (window.isFirebaseReady) {
                        console.log('   Firebase ready state:', window.isFirebaseReady());
                    }
                }
                
                console.log('   Global Firebase objects:');
                console.log('     - window.firebase:', typeof window.firebase);
                console.log('     - window.db:', typeof window.db);
                console.log('     - window.auth:', typeof window.auth);
                
                if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                    console.log('✅ Firebase ready, initializing embed...');
                    initializeEmbed();
                } else if (initAttempts < maxAttempts) {
                    console.log(`❌ Firebase not ready, retrying in ${initAttempts * 500}ms...`);
                    setTimeout(checkFirebaseAndInit, initAttempts * 500);
                } else {
                    console.error('❌ Firebase failed to initialize after', maxAttempts, 'attempts');
                    console.error('This could be due to:');
                    console.error('- Network connectivity issues');
                    console.error('- Firebase script loading failures');
                    console.error('- Firebase configuration errors');
                    showFirebaseError();
                }
            }
            
            // Start checking Firebase availability
            checkFirebaseAndInit();
            
            function initializeEmbed() {
                // Get URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('project'); // New project-based loading
                const timelineId = urlParams.get('id') || 'default'; // Legacy support
                const initialTheme = urlParams.get('theme') || 'modern';
                const initialDate = urlParams.get('date');
                const focusEventId = urlParams.get('event');
                const initialPerspectiveId = urlParams.get('perspective');
                
                console.log('=== EMBED PAGE INITIALIZATION ===');
                console.log('Full URL:', window.location.href);
                console.log('URL Search Params:', window.location.search);
                console.log('Parsed parameters:', { 
                    projectId, 
                    timelineId, 
                    initialTheme, 
                    initialDate, 
                    focusEventId, 
                    initialPerspectiveId 
                });
                console.log('Project ID found:', projectId ? `Yes: ${projectId}` : 'No');
                
                // Firebase is already confirmed to be available at this point
                console.log('🔥 Firebase Status:');
                console.log('   ✅ Firebase SDK loaded');
                console.log('   ✅ Firebase app initialized');
                console.log('   App name:', firebase.apps[0].name);
                console.log('   App project ID:', firebase.apps[0].options.projectId);
                console.log('   Firestore available:', !!firebase.firestore);
                
                // Test Firestore connectivity
                if (firebase.firestore) {
                    console.log('🔍 Testing Firestore connectivity...');
                    try {
                        firebase.firestore().enableNetwork();
                        console.log('   ✅ Firestore network enabled');
                    } catch (error) {
                        console.warn('   ⚠️ Firestore network test failed:', error.message);
                    }
                }
                
                console.log('====================================');
                
                // Store parameters globally for other functions
                window.embedParams = {
                    projectId,
                    timelineId,
                    initialTheme,
                    initialDate,
                    focusEventId,
                    initialPerspectiveId
                };
                
                // Load timeline data
                loadTimelineData();
            }
            
            async function loadTimelineData() {
                const params = window.embedParams;
                
                try {
                    showLoading();
                    
                    console.log('=== LOAD TIMELINE DATA START ===');
                    console.log('Using parameters:', params);
                    
                    // Try project-based loading first (new format)
                    if (params.projectId) {
                        console.log('📁 Loading project data from Firebase...');
                        await loadProjectData(params.projectId);
                    } else if (params.timelineId !== 'default') {
                        // Legacy timeline loading
                        console.log('📜 Loading legacy timeline data...');
                        await loadLegacyTimelineData(params.timelineId);
                    } else {
                        console.error('❌ No valid project or timeline ID provided');
                        console.log('Available params:', params);
                        showError();
                        return;
                    }
                    
                    console.log('✅ Data loading complete, initializing timeline...');
                    initializeEmbedTimeline();
                    
                } catch (error) {
                    console.error('❌ Error loading timeline:', error);
                    showError();
                }
            }
            
            async function loadProjectData(projectId) {
                console.log('=== FIREBASE DATA LOADING DEBUG ===');
                console.log('1. Starting loadProjectData with projectId:', projectId);
                
                // Load project data directly from Firebase (no auth required for reading)
                if (typeof firebase === 'undefined') {
                    console.error('❌ Firebase is not defined');
                    throw new Error('Firebase not available');
                }
                
                if (!firebase.firestore) {
                    console.error('❌ Firebase Firestore is not available');
                    throw new Error('Firestore not available');
                }
                
                console.log('✅ Firebase and Firestore are available');
                
                try {
                    console.log('2. Creating Firestore reference...');
                    const projectRef = firebase.firestore().collection('projects').doc(projectId);
                    console.log('   Collection path: projects');
                    console.log('   Document ID:', projectId);
                    console.log('   Full path: projects/' + projectId);
                    
                    console.log('3. Attempting to fetch document...');
                    const doc = await projectRef.get();
                    console.log('   Document fetch completed');
                    console.log('   Document exists:', doc.exists);
                    
                    if (doc.exists) {
                        console.log('✅ Document found, extracting data...');
                        const projectData = doc.data();
                        console.log('   Raw project data keys:', Object.keys(projectData));
                        console.log('   Project name:', projectData.name);
                        console.log('   Project description:', projectData.description);
                        console.log('   Has timelineData:', !!projectData.timelineData);
                        
                        if (projectData.timelineData) {
                            console.log('   Timeline data keys:', Object.keys(projectData.timelineData));
                            console.log('   Timeline title:', projectData.timelineData.timelineTitle);
                            console.log('   Perspectives count:', projectData.timelineData.perspectives ? projectData.timelineData.perspectives.length : 'none');
                            
                            if (projectData.timelineData.perspectives) {
                                projectData.timelineData.perspectives.forEach((persp, idx) => {
                                    console.log(`   Perspective ${idx}: ${persp.perspectiveName} - ${persp.events ? persp.events.length : 0} events`);
                                    if (persp.events && persp.events.length > 0) {
                                        console.log(`     Sample events:`, persp.events.slice(0, 2).map(e => ({title: e.title, startDate: e.startDate})));
                                    }
                                });
                            }
                        } else {
                            console.error('❌ No timelineData found in project');
                        }
                        
                        // Extract timeline data from project
                        timelineData = projectData.timelineData;
                        
                        // Add project metadata
                        if (!timelineData.timelineTitle) {
                            timelineData.timelineTitle = projectData.name;
                            console.log('   Added project name as timeline title');
                        }
                        if (!timelineData.timelineDescription) {
                            timelineData.timelineDescription = projectData.description;
                            console.log('   Added project description as timeline description');
                        }
                        
                        console.log('✅ Timeline data extracted and ready');
                        console.log('   Final timeline title:', timelineData.timelineTitle);
                        console.log('   Total perspectives:', timelineData.perspectives ? timelineData.perspectives.length : 0);
                        
                        // Calculate total events across all perspectives
                        let totalEvents = 0;
                        if (timelineData.perspectives) {
                            timelineData.perspectives.forEach(p => {
                                if (p.events) totalEvents += p.events.length;
                            });
                        }
                        console.log('   Total events across all perspectives:', totalEvents);
                        
                    } else {
                        console.error('❌ Project document does not exist:', projectId);
                        console.log('   This could mean:');
                        console.log('   - Project ID is incorrect');
                        console.log('   - Project was deleted');
                        console.log('   - Permission denied (check Firestore rules)');
                        throw new Error('Project not found');
                    }
                } catch (error) {
                    console.error('❌ Error loading project data:');
                    console.error('   Error type:', error.constructor.name);
                    console.error('   Error code:', error.code);
                    console.error('   Error message:', error.message);
                    console.error('   Full error:', error);
                    
                    if (error.code === 'permission-denied') {
                        console.error('🚫 PERMISSION DENIED - Check Firestore rules for public read access');
                    }
                    
                    throw error;
                }
                
                console.log('=== END FIREBASE DEBUG ===');
            }
            
            async function loadLegacyTimelineData(timelineId) {
                // Legacy timeline loading (backwards compatibility)
                if (typeof getTimelineFromFirestore === "function") {
                    try {
                        timelineData = await getTimelineFromFirestore(timelineId);
                        console.log("Legacy data loaded from Firestore");
                    } catch (error) {
                        console.log('Firestore failed, trying localStorage:', error);
                        loadFromLocalStorage();
                    }
                } else {
                    loadFromLocalStorage();
                }
            }
            
            function loadFromLocalStorage() {
                const savedData = localStorage.getItem(`timelineData-${timelineId}`);
                if (savedData) {
                    try {
                        timelineData = JSON.parse(savedData);
                        console.log("Data loaded from LocalStorage");
                        initializeEmbedTimeline();
                    } catch (error) {
                        console.error('Error parsing localStorage data:', error);
                        showError();
                    }
                } else {
                    console.error('No data found for timeline ID:', timelineId);
                    showError();
                }
            }
            
            function initializeEmbedTimeline() {
                console.log('=== TIMELINE INITIALIZATION DEBUG ===');
                console.log('1. Hiding loading indicator...');
                hideLoading();
                
                console.log('2. Setting timeline title...');
                const title = timelineData.timelineTitle || 'Interactive Timeline';
                document.getElementById('embed-title').textContent = title;
                console.log('   Timeline title set to:', title);
                
                // Display timeline description if available
                console.log('3. Processing timeline description...');
                if (timelineData.timelineDescription && timelineData.timelineDescription.trim() !== '') {
                    const descriptionContainer = document.getElementById('embed-description-container');
                    const descriptionElement = document.getElementById('embed-timeline-description');
                    
                    // Check if description is just placeholder text
                    if (!timelineData.timelineDescription.includes('Describe your timeline')) {
                        console.log('   Showing description container');
                        // Set the description content (supporting HTML formatting)
                        descriptionElement.innerHTML = timelineData.timelineDescription;
                        
                        // Show the description container
                        descriptionContainer.style.display = 'block';
                    } else {
                        console.log('   Hiding description (placeholder text)');
                        // Hide description container if it's just placeholder
                        descriptionContainer.style.display = 'none';
                    }
                } else {
                    console.log('   No description provided, hiding container');
                    // Hide description container if no description
                    document.getElementById('embed-description-container').style.display = 'none';
                }
                
                console.log('4. Initializing controls...');
                // Initialize controls
                initializePerspectiveControls();
                initializeThemeControls();
                
                console.log('5. Creating timeline visualization...');
                // Create timeline
                createTimeline();
                
                console.log('6. Applying initial filters...');
                // Apply initial filters
                const params = window.embedParams;
                if (params && params.initialPerspectiveId) {
                    console.log('   Setting initial perspective:', params.initialPerspectiveId);
                    setActivePerspective(params.initialPerspectiveId);
                } else {
                    console.log('   No initial perspective specified');
                }
                
                console.log('=== TIMELINE INITIALIZATION COMPLETE ===');
            }
            
            function initializePerspectiveControls() {
                if (!timelineData.perspectives || timelineData.perspectives.length <= 1) return;
                
                const perspectiveButtons = document.getElementById('perspective-buttons');
                const perspectiveControls = document.getElementById('perspective-controls');
                
                perspectiveButtons.innerHTML = '';
                
                // Add "All" button
                const allBtn = document.createElement('button');
                allBtn.className = 'perspective-btn active';
                allBtn.textContent = 'All';
                allBtn.onclick = () => setActivePerspective(null);
                perspectiveButtons.appendChild(allBtn);
                
                // Add perspective buttons
                timelineData.perspectives.forEach(perspective => {
                    const btn = document.createElement('button');
                    btn.className = 'perspective-btn';
                    btn.textContent = perspective.perspectiveName;
                    btn.style.borderLeftColor = perspective.perspectiveColor;
                    btn.onclick = () => setActivePerspective(perspective.perspectiveId);
                    perspectiveButtons.appendChild(btn);
                });
                
                perspectiveControls.style.display = 'block';
            }
            
            function initializeThemeControls() {
                if (!timelineData.themes || timelineData.themes.length === 0) return;
                
                const themeButtons = document.getElementById('theme-buttons');
                const themeControls = document.getElementById('theme-controls');
                
                themeButtons.innerHTML = '';
                
                timelineData.themes.forEach(theme => {
                    const btn = document.createElement('button');
                    btn.className = 'theme-btn';
                    btn.textContent = theme.name;
                    btn.style.borderLeftColor = theme.color;
                    btn.onclick = () => toggleTheme(theme.id, btn);
                    themeButtons.appendChild(btn);
                });
                
                themeControls.style.display = 'block';
            }
            
            function setActivePerspective(perspectiveId) {
                activePerspective = perspectiveId;
                
                // Update button states
                document.querySelectorAll('.perspective-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                if (perspectiveId === null) {
                    document.querySelector('.perspective-btn').classList.add('active'); // "All" button
                } else {
                    const targetBtn = Array.from(document.querySelectorAll('.perspective-btn'))
                        .find(btn => btn.textContent === getActivePerspectiveName(perspectiveId));
                    if (targetBtn) targetBtn.classList.add('active');
                }
                
                filterAndUpdateTimeline();
            }
            
            function toggleTheme(themeId, button) {
                if (activeThemes.has(themeId)) {
                    activeThemes.delete(themeId);
                    button.classList.remove('active');
                } else {
                    activeThemes.add(themeId);
                    button.classList.add('active');
                }
                
                filterAndUpdateTimeline();
            }
            
            function getActivePerspectiveName(perspectiveId) {
                const perspective = timelineData.perspectives.find(p => p.perspectiveId === perspectiveId);
                return perspective ? perspective.perspectiveName : '';
            }
            
            function createTimeline() {
                const container = document.getElementById('embed-timeline');
                
                const options = {
                    orientation: 'both',
                    stack: true,
                    showCurrentTime: false,
                    zoomable: true,
                    moveable: true,
                    selectable: true,
                    multiselect: false,
                    editable: false,
                    height: '100%',
                    margin: {
                        item: 10,
                        axis: 20
                    },
                    template: function(item, element, data) {
                        return `<div style="color: ${item.color || '#333'}; font-weight: bold;">${item.content}</div>`;
                    }
                };
                
                timeline = new vis.Timeline(container, visTimelineItems, options);
                
                // Handle item selection for detail view
                timeline.on('select', function(properties) {
                    if (properties.items.length > 0) {
                        const eventId = properties.items[0];
                        showEventDetails(eventId);
                    }
                });
                
                // Initial load
                filterAndUpdateTimeline();
                
                // Focus on specific event if provided
                const params = window.embedParams;
                if (params && params.focusEventId) {
                    console.log('🎯 Focusing on event:', params.focusEventId);
                    setTimeout(() => {
                        timeline.focus(params.focusEventId);
                    }, 1000);
                }
                
                // Focus on specific date if provided
                if (params && params.initialDate) {
                    console.log('📅 Moving to date:', params.initialDate);
                    setTimeout(() => {
                        timeline.moveTo(new Date(params.initialDate));
                    }, 1000);
                }
            }
            
            function filterAndUpdateTimeline() {
                console.log('=== FILTER AND UPDATE TIMELINE DEBUG ===');
                
                if (!timelineData) {
                    console.error('❌ No timelineData available for filtering');
                    return;
                }
                
                console.log('📊 Timeline data structure:');
                console.log('   timelineData exists:', !!timelineData);
                console.log('   perspectives exists:', !!timelineData.perspectives);
                console.log('   perspectives count:', timelineData.perspectives ? timelineData.perspectives.length : 0);
                console.log('   activePerspective:', activePerspective || 'ALL');
                console.log('   activeThemes size:', activeThemes.size);
                
                const filteredEvents = [];
                
                if (!timelineData.perspectives) {
                    console.error('❌ No perspectives found in timeline data');
                    return;
                }
                
                timelineData.perspectives.forEach((perspective, perspIndex) => {
                    console.log(`🔍 Processing perspective ${perspIndex}: ${perspective.perspectiveName}`);
                    console.log(`   Perspective ID: ${perspective.perspectiveId}`);
                    console.log(`   Events in perspective: ${perspective.events ? perspective.events.length : 0}`);
                    
                    // Filter by active perspective
                    if (activePerspective && perspective.perspectiveId !== activePerspective) {
                        console.log(`   ⏭️ Skipping perspective (not active): ${perspective.perspectiveName}`);
                        return;
                    }
                    
                    if (!perspective.events || perspective.events.length === 0) {
                        console.log(`   ⚠️ No events in perspective: ${perspective.perspectiveName}`);
                        return;
                    }
                    
                    perspective.events.forEach((event, eventIndex) => {
                        console.log(`   📅 Processing event ${eventIndex}: ${event.title}`);
                        console.log(`      Start date: ${event.startDate}`);
                        console.log(`      Type: ${event.type || 'point'}`);
                        console.log(`      Description: ${event.description || 'No description'}`);
                        
                        // Filter by active themes
                        if (activeThemes.size > 0) {
                            const hasActiveTheme = event.themeIds && 
                                event.themeIds.some(themeId => activeThemes.has(themeId));
                            if (!hasActiveTheme) {
                                console.log(`      ⏭️ Skipping event (theme filter): ${event.title}`);
                                return;
                            }
                        }
                        
                        // Validate event data
                        if (!event.startDate) {
                            console.warn(`      ⚠️ Event missing start date: ${event.title}`);
                            return;
                        }
                        
                        try {
                            // Convert event to vis timeline format
                            const timelineItem = {
                                id: event.id,
                                content: event.title,
                                start: new Date(event.startDate),
                                type: event.type === 'range' ? 'range' : 'point',
                                style: `background-color: ${event.eventColor || perspective.perspectiveColor}; border-color: ${event.eventColor || perspective.perspectiveColor};`,
                                title: event.description // Tooltip
                            };
                            
                            if (event.type === 'range' && event.endDate) {
                                timelineItem.end = new Date(event.endDate);
                                console.log(`      End date: ${event.endDate}`);
                            }
                            
                            console.log(`      ✅ Event converted to timeline item:`, {
                                id: timelineItem.id,
                                content: timelineItem.content,
                                start: timelineItem.start.toString(),
                                type: timelineItem.type
                            });
                            
                            filteredEvents.push(timelineItem);
                        } catch (error) {
                            console.error(`      ❌ Error converting event ${event.title}:`, error);
                        }
                    });
                });
                
                console.log('📈 Timeline update summary:');
                console.log('   Total filtered events:', filteredEvents.length);
                console.log('   Events sample:', filteredEvents.slice(0, 3).map(e => ({
                    content: e.content,
                    start: e.start.toString(),
                    type: e.type
                })));
                
                console.log('🔄 Updating vis timeline...');
                visTimelineItems.clear();
                visTimelineItems.add(filteredEvents);
                console.log('   Timeline items updated, current count:', visTimelineItems.length);
                
                console.log('=== END FILTER AND UPDATE DEBUG ===');
            }
            
            function showEventDetails(eventId) {
                // Find the event across all perspectives
                let targetEvent = null;
                for (const perspective of timelineData.perspectives) {
                    const event = perspective.events.find(e => e.id === eventId);
                    if (event) {
                        targetEvent = event;
                        break;
                    }
                }
                
                if (targetEvent) {
                    // Create a simple modal or tooltip for event details
                    // For iframe embedding, we'll keep it simple
                    const details = [
                        targetEvent.title,
                        targetEvent.description,
                        `Date: ${new Date(targetEvent.startDate).toLocaleDateString()}`
                    ].filter(Boolean).join('\n\n');
                    
                    alert(details); // Simple implementation - can be enhanced
                }
            }
            
            function showLoading() {
                document.getElementById('loading-indicator').style.display = 'flex';
                document.getElementById('error-indicator').style.display = 'none';
                document.getElementById('embed-timeline').style.display = 'none';
            }
            
            function hideLoading() {
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('embed-timeline').style.display = 'block';
            }
            
            function showError() {
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('error-indicator').style.display = 'flex';
                document.getElementById('embed-timeline').style.display = 'none';
            }
            
            function showFirebaseError() {
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('embed-timeline').style.display = 'none';
                
                const errorContainer = document.getElementById('error-indicator');
                errorContainer.innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px; color: #dc3545;"></i>
                    <span style="font-weight: bold; margin-bottom: 10px;">Firebase Connection Failed</span>
                    <small style="margin-top: 5px; color: #666;">
                        Unable to connect to Firebase database.<br>
                        Please check your internet connection and try again.
                    </small>
                    <button onclick="location.reload()" style="margin-top: 15px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Retry
                    </button>
                `;
                errorContainer.style.display = 'flex';
            }
        });
    </script>
</body>
</html>